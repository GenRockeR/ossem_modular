# Sysmon filter conf file
# Author: @sec_groundzero
# OSSEM and HELK Credits: Roberto Rodriguez (@Cyb3rWard0g) - Jose Rodriguez (@Cyb3rPandaH)


filter {
  if [log_name] =~ /^[mM]icrosoft\-[wW]indows\-[sS]ysmon\/[oO]perational$/ {
    if [event_id] == 1 {
      mutate {
        add_field => { "action" => "processcreate" }
        rename => {
          "RuleName" => "tag"
          "UtcTime" => "event_date_creation"
          "ProcessGuid" => "process_guid"
          "ProcessId" => "process_id"
          "Image" => "process_path"
          "FileVersion" => "file_version"
          "Description" => "file_description"
          "Product" => "file_product"
          "Company" => "file_company"
          "OriginalFileName" => "file_name_original"
          "CommandLine" => "process_command_line"
          "CurrentDirectory" => "file_current_directory"
          "User" => "user_name"
          "LogonGuid" => "user_logon_guid"
          "LogonId" => "user_logon_id"
          "TerminalSessionId" => "user_session_id"
          "IntegrityLevel" => "process_integrity_level"
          "Hashes" => "sysmon_hash"
          "ParentProcessGuid" => "process_parent_guid"
          "ParentProcessId" => "process_parent_id"
          "ParentImage" => "process_parent_path"
          "ParentCommandLine" => "process_parent_command_line"
        }
      }
    }

    if [event_id] == 2 {
      mutate {
        add_field => { "action" => "filecreatetime" }
        rename => {
          "RuleName" => "tag"
          "UtcTime" => "event_date_creation"
          "ProcessGuid" => "process_guid"
          "ProcessId" => "process_id"
          "Image" => "process_path"
          "TargetFileName" => "file_name"
          "CreationUtcTime" => "file_date_creation"
          "PreviousCreationUtcTime" => "file_previous_date_creation"
        }
      }
    }

    if [event_id] == 3 {
      mutate {
        add_field => { "action" => "networkconnect" }
        rename => {
          "RuleName" => "tag"
          "UtcTime" => "event_date_creation"
          "ProcessGuid" => "process_guid"
          "ProcessId" => "process_id"
          "Image" => "process_path"
          "User" => "user_name"
          "Protocol" => "network_protocol"
          "Initiated" => "network_connection_initiated"
          "SourceIsIpv6" => "src_is_ipv6"
          "SourceIp" => "src_ip_addr"
          "SourceHostname" => "src_host_name"
          "SourcePort" => "src_port"
          "SourcePortName" => "src_port_name"
          "DestinationIsIpv6" => "dst_is_ipv6"
          "DestinationIp" => "dst_ip_addr"
          "DestinationHostname" => "dst_host_name"
          "DestinationPort" => "dst_port"
          "DestinationPortName" => "dst_port_name"
        }
      }
    }

    if [event_id] == 4 {
      mutate {
        add_field => { "action" => "sysmonservicestatechanged" }
        rename => {
          "UtcTime" => "event_date_creation"
          "State" => "service_state"
          "Version" => "file_version"
          "SchemaVersion" => "sysmon_schema_version"
        }
      }
    }

    if [event_id] == 5 {
      mutate {
        add_field => { "action" => "processterminated" }
        rename => {
          "RuleName" => "tag"
          "UtcTime" => "event_date_creation"
          "ProcessGuid" => "process_guid"
          "ProcessId" => "process_id"
          "Image" => "process_path"
        }
      }
    }

    if [event_id] == 6 {
      mutate {
        add_field => { "action" => "driverload" }
        rename => {
            "RuleName" => "tag"
            "UtcTime" => "event_date_creation"
            "ImageLoaded" => "driver_loaded"
            "Hashes" => "sysmon_hash"
            "Signed" => "driver_is_signed"
            "Signature" => "driver_signature"
            "SignatureStatus" => "driver_signature_status"
        }
      }
    }

    if [event_id] == 7 {
      mutate {
        add_field => { "action" => "moduleload" }
        rename => {
            "RuleName" => "tag"
            "UtcTime" => "event_date_creation"
            "ProcessGuid" => "process_guid"
            "ProcessId" => "process_id"
            "Image" => "process_path"
            "ImageLoaded" => "module_loaded"
            "FileVersion" => "file_version"
            "Description" => "file_description"
            "Product" => "file_product"
            "Company" => "file_company"
            "OriginalFileName" => "file_name_original"
            "Hashes" => "sysmon_hash"
            "Signed" => "module_is_signed"
            "Signature" => "module_signature"
            "SignatureStatus" => "module_signature_status"
        }
      }
    }

    if [event_id] == 8 {
      mutate {
      	add_field => { "action" => "createremotethread" }
        rename => {
            "RuleName" => "tag"
            "UtcTime" => "event_date_creation"
            "SourceProcessGuid" => "process_guid"
            "SourceProcessId" => "process_id"
            "SourceImage" => "process_path"
            "TargetProcessGuid" => "target_process_guid"
            "TargetProcessId" => "target_process_id"
            "TargetImage" => "target_process_path"
            "NewThreatId" => "thread_new_id"
            "StartAddress" => "thread_start_address"
            "StartModule" => "thread_start_module"
            "StartFunction" => "thread_start_function"
        }
      }
    }

    if [event_id] == 9 {
      mutate {
      	add_field => { "action" => "rawaccessread" }
        rename => {
            "RuleName" => "tag"
            "UtcTime" => "event_date_creation"
            "ProcessGuid" => "process_guid"
            "ProcessId" => "process_id"
            "Image" => "process_path"
            "Device" => "target_device"
        }
      }
    }

    if [event_id] == 10 {
      mutate {
      	add_field => { "action" => "processaccess" }
        rename => {
            "RuleName" => "tag"
            "UtcTime" => "event_date_creation"
            "SourceProcessGuid" => "process_guid"
            "SourceProcessId" => "process_id"
            "SourceThreadId" => "thread_id"
            "SourceImage" => "process_path"
            "TargetProcessGuid" => "target_process_guid"
            "TargetProcessId" => "target_process_id"
            "TargetImage" => "target_process_path"
            "GrantedAccess" => "process_granted_access"
            "CallTrace" => "process_call_trace"
        }
      }
    }

    if [event_id] == 11 {
      mutate {
      	add_field => { "action" => "filecreate" }
        rename => {
            "RuleName" => "tag"
            "UtcTime" => "event_date_creation"
            "ProcessGuid" => "process_guid"
            "ProcessId" => "process_id"
            "Image" => "process_path"
            "TargetFileName" => "file_name"
            "CreationUtcTime" => "file_date_creation"
        }
      }
    }

   if [event_id] == 12 {
      mutate {
      	add_field => { "action" => "registryevent" }
        rename => {
            "RuleName" => "tag"
            "EventType" => "event_type"
            "UtcTime" => "event_date_creation"
            "ProcessGuid" => "process_guid"
            "ProcessId" => "process_id"
            "Image" => "process_path"
            "TargetObject" => "registry_key_path"
        }
      }
    }

    if [event_id] == 13 {
      mutate {
      	add_field => { "action" => "registryevent" }
        rename => {
            "RuleName" => "tag"
            "EventType" => "event_type"
            "UtcTime" => "event_date_creation"
            "ProcessGuid" => "process_guid"
            "ProcessId" => "process_id"
            "Image" => "process_path"
            "TargetObject" => "registry_key_path"
            "Details" => "registry_key_details"
        }
      }
    }

    if [event_id] == 14 {
      mutate {
      	add_field => { "action" => "registryevent" }
        rename => {
            "RuleName" => "tag"
            "EventType" => "event_type"
            "UtcTime" => "event_date_creation"
            "ProcessGuid" => "process_guid"
            "ProcessId" => "process_id"
            "Image" => "process_path"
            "TargetObject" => "registry_key_path"
            "NewName" => "registry_key_new_name"
        }
      }
    }

    if [event_id] == 15 {
      mutate {
      	add_field => { "action" => "filecreatestreamhash" }
        rename => {
            "RuleName" => "tag"
            "UtcTime" => "event_date_creation"
            "ProcessGuid" => "process_guid"
            "ProcessId" => "process_id"
            "Image" => "process_path"
            "TargetFileName" => "file_name"
            "CreationUtcTime" => "file_creation_time"
            "Hash" => "sysmon_hash"
        }
      }
    }

    if [event_id] == 16 {
      mutate {
      	add_field => { "source" => "ConfigurationFileHash" }
        rename => {
            "UtcTime" => "event_date_creation"
            "Configuration" => "sysmon_configuration"
            "ConfigurationFilePath" => "sysmon_configuration_hash"  
        }
      }
    }

    if [event_id] == 17 {
      mutate {
      	add_field => { "action" => "pipeevent" }
        rename => {
            "RuleName" => "tag"
            "UtcTime" => "event_date_creation"
            "ProcessGuid" => "process_guid"
            "ProcessId" => "process_id"
            "PipeName" => "pipe_name"
            "Image" => "process_path"
        }
      }
    }

    if [event_id] == 18 {
      mutate {
      	add_field => { "action" => "pipeevent" }
        rename => {
            "RuleName" => "tag"
            "UtcTime" => "event_date_creation"
            "ProcessGuid" => "process_guid"
            "ProcessId" => "process_id"
            "PipeName" => "pipe_name"
            "Image" => "process_path"
        }
      }
    }

    if [event_id] == 19 {
      mutate {
      	add_field => { "action" => "wmievent" }
        rename => {
            "RuleName" => "tag"
            "EventType" => "event_type"
            "UtcTime" => "event_date_creation"
            "Operation" => "wmi_operation"
            "User" => "user_name"
            "EventNameSpace" => "wmi_namespace"
            "Name" => "wmi_filter_name"
            "Query" => "wmi_query"
        }
      }
    }

    if [event_id] == 20 {
      mutate {
      	add_field => { "action" => "wmievent" }
        rename => {
            "RuleName" => "tag"
            "EventType" => "event_type"
            "UtcTime" => "event_date_creation"
            "Operation" => "wmi_operation"
            "User" => "user_name"
            "Name" => "wmi_consumer_name"
            "Type" => "wmi_consumer_type"
            "Destination" => "wmi_consumer_destination"
        }
      }
    }

    if [event_id] == 21 {
      mutate {
      	add_field => { "action" => "wmievent" }
        rename => {
            "RuleName" => "tag"
            "EventType" => "event_type"
            "UtcTime" => "event_date_creation"
            "Operation" => "wmi_operation"
            "User" => "user_name"
            "Consumer" => "wmi_consumer_path"
            "Filter" => "wmi_filter_path"
        }
      }
    }

    if [event_id] == 22 {
      mutate {
      	add_field => { "action" => "dnsquery" }
        rename => {
            "RuleName" => "tag
            "UtcTime" => "event_date_creation"
            "ProcessGuid" => "process_guid"
            "ProcessId" => "process_id"
            "QueryName" => "dst_host_name"
            "QueryStatus" => "dns_query_status"
            "QueryResults" => "dns_query_results"
            "Image" => "process_path"
        }
      }
    }

    if [event_id] == 23 {
      mutate {
      	add_field => { "action" => "filedelete" }
        rename => {
            "RuleName" => "tag"
            "UtcTime" => "event_date_creation"
            "ProcessGuid" => "process_guid"
            "ProcessId" => "process_id"
            "Image" => "process_path"
            "User" => "user_name"
            "TargetFileName" => "file_name"
            "Hashes" => "sysmon_hash"
            "IsExecutable" => "file_is_executable"
            "Archived" => "file_is_archived"
        }
      }
    }

 }
}




